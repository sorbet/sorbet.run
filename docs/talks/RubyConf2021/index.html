<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="generator" content="pandoc">
  <meta name="author" content="Jake Zimmerman (@jez) Trevor Elliott (@elliottt)">
  <meta name="dcterms.date" content="2021-11-10">
  <title>Compiling Ruby to Native Code with Sorbet and LLVM</title>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">
  <link rel="stylesheet" href="https://unpkg.com/reveal.js@^4/dist/reset.css">
  <link rel="stylesheet" href="https://unpkg.com/reveal.js@^4/dist/reveal.css">
  <style>
    .reveal .sourceCode {  /* see #7635 */
      overflow: visible;
    }
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    span.underline{text-decoration: underline;}
    div.column{display: inline-block; vertical-align: top; width: 50%;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {  background-color: #33365b; }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ffa27b; font-weight: bold; } /* Alert */
    code span.an { color: #aab7c4; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { } /* Attribute */
    code span.bn { color: #fcd669; } /* BaseN */
    code span.bu { } /* BuiltIn */
    code span.cf { color: #f6a4eb; } /* ControlFlow */
    code span.ch { color: #fcd669; } /* Char */
    code span.cn { color: #fcd669; } /* Constant */
    code span.co { color: #aab7c4; font-style: italic; } /* Comment */
    code span.cv { color: #aab7c4; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #aab7c4; font-style: italic; } /* Documentation */
    code span.dt { color: #74e4a2; } /* DataType */
    code span.dv { color: #fcd669; } /* DecVal */
    code span.er { color: #ffa27b; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #fcd669; } /* Float */
    code span.fu { color: #87bbfd; } /* Function */
    code span.im { color: #beb0f4; } /* Import */
    code span.in { color: #aab7c4; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #f6a4eb; } /* Keyword */
    code span.op { color: #f6a4eb; } /* Operator */
    code span.ot { color: #87bbfd; } /* Other */
    code span.pp { color: #fdbc72; } /* Preprocessor */
    code span.sc { color: #ffa27b; } /* SpecialChar */
    code span.ss { color: #ffa27b; } /* SpecialString */
    code span.st { color: #fcd669; } /* String */
    code span.va { color: #87bbfd; } /* Variable */
    code span.vs { } /* VerbatimString */
    code span.wa { color: #fdbc72; font-weight: bold; font-style: italic; } /* Warning */
    .display.math{display: block; text-align: center; margin: 0.5rem auto;}
  </style>
  <link rel="stylesheet" href="https://unpkg.com/reveal.js@^4/dist/theme/black.css" id="theme">
  <link rel="stylesheet" href="css/stripe.css"/>
  <link rel="stylesheet" href="css/line-highlights.css"/>
</head>
<body>
  <div class="reveal">
    <div class="slides">

<section id="title-slide">
  <h1 class="title">Compiling Ruby to Native Code with Sorbet and LLVM</h1>
  <p class="author">Jake Zimmerman (<strong><code>@jez</code></strong>)<br>Trevor Elliott (<strong><code>@elliottt</code></strong>)</p>
  <p class="date">November 10, 2021</p>
</section>

<section id="section" class="slide level2">
<h2></h2>
<!-- TODO(jez, trevor) practice, practice, practice -->
<!-- overal pace was quick, we need to cut stuff -->
<ul>
<li>Why does Stripe care about Ruby performance?</li>
<li>Why write a compiler for Ruby?</li>
<li>How does it work?</li>
<li>How did we adopt it?</li>
</ul>
</section>
<section id="about-stripe" class="slide level2">
<h2>üîé About Stripe</h2>
<!-- We're the company that brought you Sorbet -->
<ul>
<li><p>More than 4,000 employees</p></li>
<li><p>Company that built Sorbet</p></li>
<li><p>22% of company works <strong>permanently remote</strong></p></li>
<li><p>We‚Äôre hiring!</p>
<p>‚Üí <a href="https://stripe.com/jobs"><strong>stripe.com/jobs</strong></a></p></li>
</ul>
<aside class="notes">
<p>Working at Stripe is a great way to find out what it‚Äôs like to work in a super-typed Ruby codebase.</p>
</aside>
</section>
<section id="stripe-is-an-api-for-building-a-business" class="slide level2">
<h2>üìà Stripe is an API for building a business</h2>
<ul>
<li>Accept payments</li>
<li>Coordinate payouts</li>
<li>Manage taxes</li>
<li>Borrow &amp; lend</li>
<li>Expand globally</li>
<li>‚Ä¶</li>
</ul>
<aside class="notes">
<p>Product for pretty much everything that has to do with your business‚Äôs money needs.</p>
</aside>
</section>
<section id="stripe-uses-ruby-extensively" class="slide level2">
<h2>üíé Stripe uses <strong>Ruby</strong> extensively</h2>
<ul>
<li><p>Powers our most important services (Stripe API)</p></li>
<li><p>Hundreds of engineers use Ruby daily</p></li>
<li><p>Millions of lines of code (monorepo)</p></li>
<li><p>Massive type coverage with Sorbet</p></li>
</ul>
</section>
<section id="api-latency-is-a-feature" class="slide level2">
<h2>API latency is a feature ‚ú®</h2>
<ul>
<li><p>Stripe users want <strong>lower latency</strong></p></li>
<li><p>Stripe API runs on every checkout</p></li>
</ul>
<aside class="notes">
<p>You‚Äôre going to choose the faster API over the slower API if they‚Äôre otherwise equal.</p>
</aside>
</section>
<section id="visualizing-api-latency" class="slide level2">
<h2>Visualizing API Latency</h2>
<p><img data-src="img/request-breakdown-no-header.png" /></p>
<aside class="notes">
<p>I/O is sizable, but is being tackled by other projects‚Äîcompiler focuses on Ruby</p>
<p>Ruby portion is owned by many teams (have their own priorities)</p>
<p>Dozens and dozens of teams‚Äô code</p>
</aside>
</section>
<section id="section-1" class="slide level2">
<h2></h2>
<p><img data-src="img/compiler-leverage-1.png" /></p>
</section>
<section id="section-2" class="slide level2">
<h2></h2>
<p><img data-src="img/compiler-leverage-2.png" /></p>
<aside class="notes">
<p>generous: hottest files take &lt;1% of request duration</p>
</aside>
</section>
<section id="section-3" class="slide level2">
<h2></h2>
<p><img data-src="img/compiler-leverage-3.png" /></p>
<aside class="notes">
<p>‚Äúif the compiler works, it has the potential to speed up all pieces‚Äù</p>
<p>high-leverage</p>
</aside>
</section>
<section id="why-build-a-compiler" class="slide level2">
<h2>Why build a compiler‚Ä¶? ü§î</h2>
<div>
<ul>
<li class="fragment">‚Ä¶ at all?</li>
<li class="fragment">‚Ä¶ instead of a JIT compiler?</li>
<li class="fragment">‚Ä¶ instead of using TruffleRuby or JRuby?</li>
<li class="fragment">‚Ä¶ for Ruby, instead of using another language?</li>
</ul>
</div>
<aside class="notes">
<ol type="1">
<li>Sorbet has view of whole program</li>
<li>compiler is simpler (to implement, to debug)</li>
<li>our compiler is incremental</li>
<li>partly are doing this, but too much to ask to rewrite everything</li>
</ol>
</aside>
<!------------------- switch to trevor ------------------->
<!-- why do we expect a compiler to work for Ruby a priori? -->
<!-- nathan has bits about this in the nonvergence talk -->
</section>
<section id="sorbet" class="slide level2">
<h2>Sorbet</h2>
<!-- surprising that sorbet was not mentioned very much, or that it was so late in the pipeline -->
<ul>
<li>A typechecker for ruby with a powerful static analysis pass</li>
<li>A gradual type system, allowing users to locally opt-out of type checking</li>
</ul>
</section>
<section id="sorbet-example" class="slide level2">
<h2>Sorbet Example</h2>
<div class="sourceCode" id="cb1"><pre class="sourceCode ruby"><code class="sourceCode ruby"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>sig <span class="cf">do</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>  params(<span class="wa">x: </span>T<span class="kw">::</span><span class="dt">Array</span><span class="kw">[</span><span class="dt">Integer</span><span class="kw">]</span>)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">.returns</span>(T<span class="kw">::</span><span class="dt">Array</span><span class="kw">[</span><span class="dt">Integer</span><span class="kw">]</span>)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="cf">def</span> f(x)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>  x<span class="at">.map</span> <span class="kw">{|</span>v<span class="kw">|</span> v <span class="kw">+</span> <span class="dv">1</span><span class="kw">}</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span></code></pre></div>
</section>
<section id="catching-a-type-error" class="slide level2">
<h2>Catching a type error</h2>
<div class="sourceCode" id="cb2"><pre class="sourceCode ruby hl-6"><code class="sourceCode ruby"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>sig <span class="cf">do</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>  params(<span class="wa">x: </span>T<span class="kw">::</span><span class="dt">Array</span><span class="kw">[</span><span class="dt">Integer</span><span class="kw">]</span>)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">.returns</span>(T<span class="kw">::</span><span class="dt">Array</span><span class="kw">[</span><span class="dt">Integer</span><span class="kw">]</span>)</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="cf">def</span> f(x)</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>  x<span class="at">.map</span> <span class="kw">{|</span>v<span class="kw">|</span> v <span class="kw">+</span> <span class="dv">1</span><span class="kw">}</span><span class="at">.to_s</span> <span class="co"># static error!</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span></code></pre></div>
<aside class="notes">
<p>We introduced an error by producing an array of strings instead of an array of integers, and sorbet flags this statically</p>
</aside>
</section>
<section id="llvm" class="slide level2">
<h2>LLVM</h2>
<ul>
<li>A toolkit that powers many compilers today</li>
<li>clang, ghc, swift, ‚Ä¶</li>
</ul>
</section>
<section id="sorbet-llvm-sorbet-compiler" class="slide level2">
<h2>Sorbet + LLVM = Sorbet Compiler</h2>
<ul>
<li>Sorbet, augmented with an additional pass to generate LLVM IR</li>
<li>LLVM is used to generate native code</li>
</ul>
<aside class="notes">
<p>Our type annotations help LLVM to generate better code.</p>
<p>Runtime type-checks are coalesced to both reduce the amount of typechecking at runtime, and enable more aggressive inlining.</p>
</aside>
</section>
<section id="compiling-the-example" class="slide level2">
<h2>Compiling the example</h2>
<div class="sourceCode" id="cb3"><pre class="sourceCode ruby"><code class="sourceCode ruby"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>sig <span class="cf">do</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>  params(<span class="wa">x: </span>T<span class="kw">::</span><span class="dt">Array</span><span class="kw">[</span><span class="dt">Integer</span><span class="kw">]</span>)</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">.returns</span>(T<span class="kw">::</span><span class="dt">Array</span><span class="kw">[</span><span class="dt">Integer</span><span class="kw">]</span>)</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="cf">def</span> f(x)</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>  x<span class="at">.map</span> <span class="kw">{|</span>v<span class="kw">|</span> v <span class="kw">+</span> <span class="dv">1</span><span class="kw">}</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span></code></pre></div>
<aside class="notes">
<p>We‚Äôll use some pseudo-code to illustrate the transformations the compiler will apply</p>
</aside>
</section>
<section id="leveraging-types-the-compilers-view" class="slide level2">
<h2>Leveraging types (the compiler‚Äôs view)</h2>
<div class="sourceCode" id="cb4"><pre class="sourceCode ruby hl-2 hl-4"><code class="sourceCode ruby"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="cf">def</span> f(x)</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">raise</span> <span class="cf">unless</span> x<span class="at">.is_a?</span>(<span class="dt">Array</span>)</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>  t <span class="kw">=</span> x<span class="at">.map</span> <span class="kw">{|</span>v<span class="kw">|</span> v <span class="kw">+</span> <span class="dv">1</span><span class="kw">}</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">raise</span> <span class="cf">unless</span> t<span class="at">.is_a?</span>(<span class="dt">Array</span>)</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>  t</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span></code></pre></div>
<aside class="notes">
<p>The signature is checked unconditionally at runtime, and produce assumptions for us to reuse later. Parameter and return value validation moves into the function body.</p>
<p>The check for <code>x</code> is now specialized to <code>Array</code>.</p>
<p>The return value has been named, and its runtime type-check is also specialized to <code>Array</code>.</p>
</aside>
</section>
<section id="leveraging-types-the-compilers-view-1" class="slide level2">
<h2>Leveraging types (the compiler‚Äôs view)</h2>
<div class="sourceCode" id="cb5"><pre class="sourceCode ruby hl-3"><code class="sourceCode ruby"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="cf">def</span> f(x)</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">raise</span> <span class="cf">unless</span> x<span class="at">.is_a?</span>(<span class="dt">Array</span>)</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  t <span class="kw">=</span> x<span class="at">.map</span> <span class="kw">{|</span>v<span class="kw">|</span> v <span class="kw">+</span> <span class="dv">1</span><span class="kw">}</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">raise</span> <span class="cf">unless</span> t<span class="at">.is_a?</span>(<span class="dt">Array</span>)</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>  t</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span></code></pre></div>
<aside class="notes">
<ul>
<li>At this point we know that <code>x</code> is an <code>Array</code>, and can dispatch to a faster implementation of <code>map</code></li>
</ul>
</aside>
</section>
<section id="leveraging-types-skipping-the-vm-to-call-map-directly" class="slide level2">
<h2>Leveraging types (skipping the vm to call map directly)</h2>
<div class="sourceCode" id="cb6"><pre class="sourceCode ruby hl-3"><code class="sourceCode ruby"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="cf">def</span> f(x)</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">raise</span> <span class="cf">unless</span> x<span class="at">.is_a?</span>(<span class="dt">Array</span>)</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  t <span class="kw">=</span> rb_ary_collect(x) <span class="cf">do</span> <span class="kw">|</span>v<span class="kw">|</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>    v <span class="kw">+</span> <span class="dv">1</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">end</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">raise</span> <span class="cf">unless</span> t<span class="at">.is_a?</span>(<span class="dt">Array</span>)</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>  t</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span></code></pre></div>
<aside class="notes">
<ul>
<li>This is hand-wavy: setting up the block for the call to <code>rb_ary_collect</code> takes more work than this</li>
</ul>
</aside>
</section>
<section id="leveraging-types-inlining-the-definition-of-map" class="slide level2">
<h2>Leveraging types (inlining the definition of map)</h2>
<div class="sourceCode" id="cb7"><pre class="sourceCode ruby"><code class="sourceCode ruby"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="cf">def</span> f(x)</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">raise</span> <span class="cf">unless</span> x<span class="at">.is_a?</span>(<span class="dt">Array</span>)</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  t <span class="kw">=</span> <span class="kw">[]</span>; i <span class="kw">=</span> <span class="dv">0</span>; len <span class="kw">=</span> x<span class="at">.length</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">while</span> i <span class="kw">&lt;</span> len</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>    t <span class="kw">&lt;&lt;</span> <span class="kw">&lt;</span>callblock<span class="kw">&gt;</span>(x<span class="kw">[</span>i<span class="kw">]</span>) <span class="kw">{|</span>v<span class="kw">|</span> v <span class="kw">+</span> <span class="dv">1</span><span class="kw">}</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>    i <span class="kw">+=</span> <span class="dv">1</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">end</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">raise</span> <span class="cf">unless</span> t<span class="at">.is_a?</span>(<span class="dt">Array</span>)</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>  t</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span></code></pre></div>
<aside class="notes">
<ul>
<li>We can inline the definition of <code>rb_ary_collect</code> constructing the array directly instead</li>
</ul>
</aside>
</section>
<section id="leveraging-types-inlining-the-block" class="slide level2">
<h2>Leveraging types (inlining the block)</h2>
<div class="sourceCode" id="cb8"><pre class="sourceCode ruby"><code class="sourceCode ruby"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="cf">def</span> f(x)</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">raise</span> <span class="cf">unless</span> x<span class="at">.is_a?</span>(<span class="dt">Array</span>)</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>  t <span class="kw">=</span> <span class="kw">[]</span>; i <span class="kw">=</span> <span class="dv">0</span>; len <span class="kw">=</span> x<span class="at">.length</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">while</span> i <span class="kw">&lt;</span> len</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>    t <span class="kw">&lt;&lt;</span> x<span class="kw">[</span>i<span class="kw">]</span> <span class="kw">+</span> <span class="dv">1</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>    i <span class="kw">+=</span> <span class="dv">1</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">end</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">raise</span> <span class="cf">unless</span> t<span class="at">.is_a?</span>(<span class="dt">Array</span>)</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>  t</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span></code></pre></div>
<aside class="notes">
<ul>
<li>There‚Äôs no longer any need for the block to be called, and we can inline it in the body of the loop</li>
</ul>
</aside>
</section>
<section id="leveraging-types-removing-additional-method-calls" class="slide level2">
<h2>Leveraging types (removing additional method calls)</h2>
<div class="sourceCode" id="cb9"><pre class="sourceCode ruby hl-3 hl-5"><code class="sourceCode ruby"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="cf">def</span> f(x)</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">raise</span> <span class="cf">unless</span> x<span class="at">.is_a?</span>(<span class="dt">Array</span>)</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>  t <span class="kw">=</span> <span class="kw">[]</span>; i <span class="kw">=</span> <span class="dv">0</span>; len <span class="kw">=</span> x<span class="at">.length</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">while</span> i <span class="kw">&lt;</span> len</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>    t <span class="kw">&lt;&lt;</span> x<span class="kw">[</span>i<span class="kw">]</span> <span class="kw">+</span> <span class="dv">1</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>    i <span class="kw">+=</span> <span class="dv">1</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">end</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">raise</span> <span class="cf">unless</span> t<span class="at">.is_a?</span>(<span class="dt">Array</span>)</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>  t</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span></code></pre></div>
<aside class="notes">
<ul>
<li>We can further inline other calls to methods on <code>x</code>, inlining the calls to <code>length</code> and <code>[]</code>, and the <code>&lt;&lt;</code> method on <code>t</code></li>
</ul>
</aside>
</section>
<section id="leveraging-types-removing-redundant-type-tests" class="slide level2">
<h2>Leveraging types (removing redundant type tests)</h2>
<div class="sourceCode" id="cb10"><pre class="sourceCode ruby hl-8"><code class="sourceCode ruby"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="cf">def</span> f(x)</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">raise</span> <span class="cf">unless</span> x<span class="at">.is_a?</span>(<span class="dt">Array</span>)</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>  t <span class="kw">=</span> <span class="kw">[]</span>; i <span class="kw">=</span> <span class="dv">0</span>; len <span class="kw">=</span> x<span class="at">.length</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">while</span> i <span class="kw">&lt;</span> len</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>    t <span class="kw">&lt;&lt;</span> x<span class="kw">[</span>i<span class="kw">]</span> <span class="kw">+</span> <span class="dv">1</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>    i <span class="kw">+=</span> <span class="dv">1</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">end</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">raise</span> <span class="cf">unless</span> t<span class="at">.is_a?</span>(<span class="dt">Array</span>)</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>  t</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span></code></pre></div>
<aside class="notes">
<ul>
<li>We know that <code>t</code> will always be an array, so we can remove the check on the return value</li>
</ul>
</aside>
</section>
<section id="final-version" class="slide level2">
<h2>Final version</h2>
<!-- TODO(trevor) make it clear that the compiler is not source-to-source -->
<div class="sourceCode" id="cb11"><pre class="sourceCode ruby"><code class="sourceCode ruby"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="cf">def</span> f(x)</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">raise</span> <span class="cf">unless</span> x<span class="at">.is_a?</span>(<span class="dt">Array</span>)</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>  t <span class="kw">=</span> <span class="kw">[]</span>; i <span class="kw">=</span> <span class="dv">0</span>; len <span class="kw">=</span> x<span class="at">.length</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">while</span> i <span class="kw">&lt;</span> len</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>    t <span class="kw">&lt;&lt;</span> x<span class="kw">[</span>i<span class="kw">]</span> <span class="kw">+</span> <span class="dv">1</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>    i <span class="kw">+=</span> <span class="dv">1</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">end</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>  t</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span></code></pre></div>
<aside class="notes">

</aside>
</section>
<section id="section-4" class="slide level2">
<h2></h2>
<!-- TODO(trevor) maybe move this earlier, before example -->
<p><img data-src="img/sorbet-llvm-pipeline.png" /></p>
<!-- ![](img/compiled-code-in-production.png) -->
<aside class="notes">
<p>the ‚ÄúLLVM‚Äù part is only like extra 15k lines</p>
</aside>
</section>
<section id="requirements-of-source" class="slide level2">
<h2>Requirements of source</h2>
<!-- will people even know what typed: sigils are? -->
<ul>
<li>Must be <strong><code># typed: true</code></strong> or higher</li>
<li>Must enable <strong><code># frozen_string_literal: true</code></strong></li>
<li>Must be marked <strong><code># compiled: true</code></strong></li>
</ul>
<aside class="notes">
<p>Sorbet doesn‚Äôt generate a CFG for <code>typed: false</code> and lower files.</p>
<p>We intern string constants.</p>
<p>This last point is subtle: we opt-in to compilation on a per-file basis.</p>
</aside>
</section>
<section id="code-generation" class="slide level2">
<h2>Code Generation</h2>
<!-- can we roll this whole section into just pointing out LLVM in the picture? -->
<!-- this was the first mention of CFG, wasn't really clear what that means? -->
<ul>
<li>LLVM IR is generated from a typechecked CFG</li>
<li>The code generation pass and runtime support adds about 15k lines of code</li>
</ul>
<aside class="notes">
<p>The 15k lines are 5k of runtime support and 10k of actual code-generation pass.</p>
</aside>
</section>
<section id="modifying-the-ruby-vm" class="slide level2">
<h2>Modifying the ruby VM</h2>
<!-- focus on "we have support code that we link into the VM for convenience" more than "we arbitrarily modify the VM"

- Expose more symbols for runtime linking
- Add a new sorbet calling convention for methods compiled by sorbet

::: notes

We need to expose previously hidden methods, `rb_ary_compact_bang` for example, so that we can call them directly when appropriate

* Reasons for the sorbet calling convention
  * speed up method calls with keyword args
  * move common method frame setup code into the vm

:::

## Loading compiled code

- Stripe already monkey patches require for our autoloader
- Let‚Äôs use that monkey patch to also make the decision about loading a shared objects

## Deploying Compiled Code

<!-- potential cut? -->
<ul>
<li>We make changes frequently to the vm, and re-deploying to hosts wasn‚Äôt an acceptable solution</li>
<li>What about bundling ruby into the deployment artifacts?</li>
</ul>
<aside class="notes">
<ul>
<li>Re-deploying ruby to hosts each time we made a change would be onerous and would significantly decrease development velocity on the compiler</li>
</ul>
</aside>
</section>
<section id="deploying-compiled-code-additional-benefits" class="slide level2">
<h2>Deploying Compiled Code (Additional benefits)</h2>
<ul>
<li>Canarying ruby upgrades is much simpler now</li>
<li>We run tests with the same patched vm in CI that goes out to production</li>
</ul>
<aside class="notes">
<p>After getting compiled code running in production, our next step was to validate our hypothesis by profiling the running compiled code. Jake will describe what went into setting all of that up at Stripe.</p>
</aside>
<!-------------------- switch to jez --------------------->
</section>
<section id="adopting-in-production" class="slide level2">
<h2>Adopting in production</h2>
<!-- TODO(jez) we test in CI too, not only in production -->
<ol type="1">
<li>Compare performance on real traffic</li>
<li>Must be incremental</li>
<li>Plan for when things go wrong</li>
</ol>
<!-- mature company, have existing guardrails -->
<aside class="notes">
<p>incremental == iteration speed</p>
</aside>
</section>
<section id="real-traffic-small-blast-radius" class="slide level2">
<h2>Real traffic, small blast radius</h2>
<p><img data-src="img/api-fleet.png" /></p>
</section>
<section id="stackprof-in-production" class="slide level2">
<h2>Stackprof in production üë∑‚Äç‚ôÇÔ∏è</h2>
<!-- this might be in the weeds. maybe just mention stackprof and move on -->
<!-- uses standard ruby tools--compiler just works with all this stuff -->
<p><img data-src="img/stackprof.png" /></p>
<aside class="notes">
<p>Record contents of stack periodically</p>
<p>Use existing Ruby tools!</p>
<p>Reuse another team‚Äôs work (to measure interpreted code)</p>
<p>Bunch of things we can do with this information</p>
</aside>
</section>
<section id="compile-incrementally-most-important-first" class="slide level2">
<h2>üèÜ Compile incrementally, most important first</h2>
<p><img data-src="img/stackprof.png" /></p>
<aside class="notes">
<p>Compiling file with <code>A</code> is more important than <code>B</code> (B always calls into <code>A</code> anyways)</p>
<p>Rank all files required by importance to production</p>
<p>Low effort, high reward</p>
<p>‚ÄúShould we implements support for X or Y first?‚Äù</p>
</aside>
</section>
<section id="estimate-latency-of-single-method" class="slide level2">
<h2>Estimate latency of single method ‚öñÔ∏è</h2>
<p><img data-src="img/stackprof-estimate.png" /></p>
<aside class="notes">
<p>Did we make <code>A#bar</code> faster or slower?</p>
</aside>
</section>
<section id="track-how-much-of-request-runs-compiled" class="slide level2">
<h2>‚è± Track how much of request runs compiled</h2>
<p><img data-src="img/time-in-compiled-files.png" /></p>
</section>
<section id="plan-for-when-things-go-wrong" class="slide level2">
<h2>Plan for when things go wrong üò±</h2>
<p><img data-src="img/api-fleet.png" /></p>
<aside class="notes">
<ol type="1">
<li>Flip a feature flag (no code change, build, no deploy)</li>
<li>All compiled code off in under 30 seconds</li>
</ol>
<p>Rest of the organization is happy with us experimenting</p>
</aside>
</section>
<section id="whats-next" class="slide level2">
<h2>What‚Äôs next?</h2>
<!-- should we have a slide here explaining why we're not talking about numbers? -->
<!-- "this is what we're getting out of it" -->
<!-- we've learned a lot about how to build fast C extensions, and we're eager to chat with people about potential modifications to the Ruby C API that would make C extensions more powerful and also allow the compiler to be faster -->
<ul>
<li>Increase adoption (fraction running compiled)</li>
<li>Profile and optimize (improve compiled performance)</li>
<li>Keep time-to-compile low (developer productivity)</li>
</ul>
</section>
<section id="questions" class="slide level2">
<h2>Questions? üôã‚Äç‚ôÇÔ∏è</h2>
</section>
    </div>
  </div>

  <script src="https://unpkg.com/reveal.js@^4/dist/reveal.js"></script>

  <!-- reveal.js plugins -->
  <script src="https://unpkg.com/reveal.js@^4/plugin/notes/notes.js"></script>
  <script src="https://unpkg.com/reveal.js@^4/plugin/search/search.js"></script>
  <script src="https://unpkg.com/reveal.js@^4/plugin/zoom/zoom.js"></script>

  <script>

      // Full list of configuration options available at:
      // https://revealjs.com/config/
      Reveal.initialize({
        // Display controls in the bottom right corner
        controls: false,

        // Help the user learn the controls by providing hints, for example by
        // bouncing the down arrow when they first encounter a vertical slide
        controlsTutorial: true,

        // Determines where controls appear, "edges" or "bottom-right"
        controlsLayout: 'bottom-right',

        // Visibility rule for backwards navigation arrows; "faded", "hidden"
        // or "visible"
        controlsBackArrows: 'faded',

        // Display a presentation progress bar
        progress: true,

        // Display the page number of the current slide
        slideNumber: "c/t",

        // 'all', 'print', or 'speaker'
        showSlideNumber: 'all',

        // Add the current slide number to the URL hash so that reloading the
        // page/copying the URL will return you to the same slide
        hash: false,

        // Start with 1 for the hash rather than 0
        hashOneBasedIndex: false,

        // Flags if we should monitor the hash and change slides accordingly
        respondToHashChanges: true,

        // Push each slide change to the browser history
        history: true,

        // Enable keyboard shortcuts for navigation
        keyboard: true,

        // Enable the slide overview mode
        overview: true,

        // Disables the default reveal.js slide layout (scaling and centering)
        // so that you can use custom CSS layout
        disableLayout: false,

        // Vertical centering of slides
        center: true,

        // Enables touch navigation on devices with touch input
        touch: true,

        // Loop the presentation
        loop: false,

        // Change the presentation direction to be RTL
        rtl: false,

        // see https://revealjs.com/vertical-slides/#navigation-mode
        navigationMode: 'default',

        // Randomizes the order of slides each time the presentation loads
        shuffle: false,

        // Turns fragments on and off globally
        fragments: true,

        // Flags whether to include the current fragment in the URL,
        // so that reloading brings you to the same fragment position
        fragmentInURL: true,

        // Flags if the presentation is running in an embedded mode,
        // i.e. contained within a limited portion of the screen
        embedded: false,

        // Flags if we should show a help overlay when the questionmark
        // key is pressed
        help: true,

        // Flags if it should be possible to pause the presentation (blackout)
        pause: true,

        // Flags if speaker notes should be visible to all viewers
        showNotes: false,

        // Global override for autoplaying embedded media (null/true/false)
        autoPlayMedia: null,

        // Global override for preloading lazy-loaded iframes (null/true/false)
        preloadIframes: null,

        // Number of milliseconds between automatically proceeding to the
        // next slide, disabled when set to 0, this value can be overwritten
        // by using a data-autoslide attribute on your slides
        autoSlide: 0,

        // Stop auto-sliding after user input
        autoSlideStoppable: true,

        // Use this method for navigation when auto-sliding
        autoSlideMethod: null,

        // Specify the average time in seconds that you think you will spend
        // presenting each slide. This is used to show a pacing timer in the
        // speaker view
        defaultTiming: null,

        // Enable slide navigation via mouse wheel
        mouseWheel: false,

        // The display mode that will be used to show slides
        display: 'block',

        // Hide cursor if inactive
        hideInactiveCursor: false,

        // Time before the cursor is hidden (in ms)
        hideCursorTime: 5000,

        // Opens links in an iframe preview overlay
        previewLinks: false,

        // Transition style (none/fade/slide/convex/concave/zoom)
        transition: 'none',

        // Transition speed (default/fast/slow)
        transitionSpeed: 'default',

        // Transition style for full page slide backgrounds
        // (none/fade/slide/convex/concave/zoom)
        backgroundTransition: 'fade',

        // Number of slides away from the current that are visible
        viewDistance: 3,

        // Number of slides away from the current that are visible on mobile
        // devices. It is advisable to set this to a lower number than
        // viewDistance in order to save resources.
        mobileViewDistance: 2,

        // reveal.js plugins
        plugins: [
          RevealNotes,
          RevealSearch,
          RevealZoom
        ]
      });
    </script>
    <script src="js/toggle-theme.js"></script>
    </body>
</html>
